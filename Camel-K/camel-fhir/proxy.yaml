# camel-k: language=yaml dependency=camel-base64 dependency=camel-fhir dependency=camel-netty-http config=configmap:camelfhir config=secret:fhirauthentication resource=configmap:xslt@/xslt 

- rest:
    binding-mode: auto
    get: 
      - uri: "/get/{category}/{id}"
        api-docs: true
        produces: "application/fhir+json"  
        steps:
          - to: direct:auth
          - tod: "fhir:read/resourceById?resourceClass=${header.category}&stringId=${header.id}&serverUrl={{fhirserverURL}}&encoding=JSON&fhirVersion=R4"
          - to: direct:output        
    post:
      - uri: "/transaction"
        consumes: "application/fhirjson"
        produces: "application/xml"
        steps:
          - unmarshal:
              id: readJson
              fhir-json:
                fhir-version: R4
                pretty-print: false
          - to: log:info?showAll=true
          - marshal:
              id: writeXML
              fhir-xml:
                fhir-version: R4
                pretty-print: false
          - to: log:info
          - to: xslt:/xslt/fixbundle.xsl
          - tod: fhir:transaction/inBody=resource&serverUrl={{fhirserverURL}}&encoding=XML&fhirVersion=R4
      - uri: "/bundle"
        consumes: "application/fhirjson"
        steps:           
          - split:
              jsonpath: "$.entry[0]"
              steps:
              - set-body:
                  jsonpath: "$.resource"
              - set-property:
                  name: resourceType
                  jsonpath: "$.resourceType"
              - set-property:
                  name: resource_id
                  jsonpath: "$.id"
              - marshal:
                  json:
                    library: Jackson
              - unmarshal:
                  id: tofhir
                  fhir-json:
                    fhir-version: R4
                    pretty-print: false
              - to: log:info?showAllProperties=true
              - tod: fhir:update/resource?inBody=resource&stringId=${exchangeProperty.resource_id}&serverUrl={{fhirserverURL}}&encoding=JSON&fhirVersion=R4
          - set-body:
              constant: '{"the":"absolute-end"}'
                    
- from: 
    uri: direct:output
    steps:
      - marshal:
          fhirJson:
            fhir-version: R4
            pretty-print: false
      - to: log:info?showAll=true

- from: 
    uri: direct:auth
    steps:
      - choice:
          when:
            - simple: "{{enableAuthentication}} == true"
              steps:
                - to: direct:auth2
  
- from: 
    uri: direct:auth2
    steps:                  
      - set-body:
          constant: "{{account}}:{{secret}}"
      - marshal:
          base64:
            line-length: 0
            id: b64auth
      - remove-headers:
          pattern: "*"
      - set-header:
          name: auth 
          simple: "${body}"
      - transform:
          constant: 'grant_type=client_credentials&scope=system/DocumentReference.write system/DocumentReference.read'
      - set-header:
          name: CamelHttpMethod
          expression:
            constant: POST
      - set-header:
          name: Accept
          expression:
            constant: "application/json"
      - set-header:
          name: "Authorization"
          simple: "Basic ${header.auth}"
      - remove-headers:
          pattern: "auth"
      - set-header:
          name: "Content-Type"
          expression:
            constant: "application/x-www-form-urlencoded"
      - set-header:
          name: "cache-control"
          expression:
            constant: "no-cache"
      - to: 
          uri: "netty-http:https://{{authserver}}/tenants/{{tenant-id}}/protocols/oauth2/profiles/smart-v1/token?throwExceptionOnFailure=false&traceEnabled=true&keepAlive=false"
          pattern: "InOut"
      - set-property:
          name: token
          jsonpath: $.access_token
      - to: kamelet:log-sink?showHeaders=true